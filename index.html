<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <title>Whatsapp</title>
</head>
<body>
    <div class="chatOptions" id="chatOptions">
        <!-- Lista de usuários será adicionada aqui dinamicamente -->
    </div>
    <div class="chatInterface">
        <div class="modal" id="usernameModal">
            <div class="conteudoModal">
                <h1>Bem-vindo ao Whatsapp!</h1>
                <h2>Digite seu nome de usuário</h2>
                <input type="text" id="nameInput" placeholder="Nome" required>
                <button id="setUsernameButton">Salvar</button>
            </div>
        </div>
        
        <div class="chatBox">
            <h2 id="chatUsername">Username</h2>
            <div class="areaMensagem" id="areaMensagem"></div>
            <div class="inputCaixa">
                <input type="text" id="msgInput" placeholder="Digite sua mensagem aqui" required>
                <button id="sendButton">Enviar</button>
            </div>
        </div>
    </div>
    <div class="sticker">
        <img src="imagens/chat.png">
        <span>Illustration by <a href="https://icons8.com/illustrations/author/zD2oqC8lLBBA">Icons 8</a> from <a href="https://icons8.com/illustrations">Ouch!</a></span>
    </div>
    <script>
        let socket;
        let username = '';
        let selectedUserId = '';
        let messageHistories = {}; // {userId: {recipientId: [messages]}}
        let isSocketOpen = false; // Track WebSocket connection state

        function connectWebSocket() {
            socket = new WebSocket('ws://localhost:8765');

            socket.onopen = function () {
                console.log('Conectado ao servidor WebSocket');
                isSocketOpen = true; // Set the flag to true when the connection is open
            };

            socket.onmessage = function (event) {
                const message = JSON.parse(event.data);

                if (message.type === 'user_list') {
                    updateUserList(message.users);
                } else if (message.type === 'chat') {
                    if (message.sender === selectedUserId || message.recipient === selectedUserId) {
                        addMessageToHistory(message);
                        if (message.recipient === selectedUserId) {
                            displayMessage(message);
                        }
                    }
                } else if (message.type === 'history') {
                    const areaMensagem = document.getElementById('areaMensagem');
                    areaMensagem.innerHTML = '';  // Clear existing messages
                    message.history.forEach(msg => {
                        const msgData = JSON.parse(msg);
                        displayMessage(msgData);
                    });
                }
            };

            socket.onclose = function () {
                console.log('Desconectado do servidor WebSocket');
                isSocketOpen = false; // Reset the flag when the connection is closed
            };
        }

        function updateUserList(users) {
            const chatOptions = document.getElementById('chatOptions');
            chatOptions.innerHTML = '';  // Clear existing users

            Object.entries(users).forEach(([userId, name]) => {
                const button = document.createElement('button');
                button.className = 'userOption';
                button.innerText = name; // Set the button text to the username
                button.addEventListener('click', function () {
                    selectUser(userId);
                });
                chatOptions.appendChild(button);
            });
        }

        function selectUser(userId) {
            selectedUserId = userId;
            document.getElementById('chatUsername').innerText = username;
            if (!messageHistories[selectedUserId]) {
                messageHistories[selectedUserId] = {};
            }
            requestHistory(selectedUserId);
        }

        function requestHistory(userId) {
            if (username && isSocketOpen) {
                const request = {
                    type: 'request_history',
                    recipient: userId
                };
                socket.send(JSON.stringify(request));
            }
        }

        function addMessageToHistory(message) {
            if (!messageHistories[message.sender]) {
                messageHistories[message.sender] = {};
            }
            if (!messageHistories[message.sender][message.recipient]) {
                messageHistories[message.sender][message.recipient] = [];
            }
            messageHistories[message.sender][message.recipient].push(JSON.stringify(message));
        }

        function displayMessage(message) {
            const areaMensagem = document.getElementById('areaMensagem');
            areaMensagem.innerHTML += `<div><strong>${message.sender}:</strong> ${message.text}</div>`;
        }

        document.getElementById('setUsernameButton').addEventListener('click', function () {
            const nameInput = document.getElementById('nameInput');
            username = nameInput.value.trim();
            if (username) {
                document.getElementById('usernameModal').style.display = 'none';
                connectWebSocket();
                const registrationMessage = {
                    type: 'register',
                    username: username
                };
                if (isSocketOpen) {
                    socket.send(JSON.stringify(registrationMessage));
                } else {
                    socket.onopen = function () {
                        isSocketOpen = true; // Ensure WebSocket is open before sending the registration message
                        socket.send(JSON.stringify(registrationMessage));
                    };
                }
            }
        });

        document.getElementById('sendButton').addEventListener('click', function () {
            if (selectedUserId && username && isSocketOpen) {
                const msgInput = document.getElementById('msgInput');
                const message = {
                    type: 'chat',
                    sender: username,
                    recipient: selectedUserId,
                    text: msgInput.value.trim()
                };
                socket.send(JSON.stringify(message));
                msgInput.value = '';
                addMessageToHistory(message);  // Add message to history for display
                displayMessage(message);  // Immediately display message sent by the user
            }
        });

        window.onload = function() {
            document.getElementById('usernameModal').style.display = 'flex';
        }
    </script>
</body>
</html>
